
{% extends "base.html" %}

{% block head %}
	{{ super() }}
	<style type="text/css">

		#bookTitle {
			font-family: 'Barlow', sans-serif; 
			color: black; 
			font-size: 17px; 
			letter-spacing: 0.1em;
		}

		#bookAuthor {
			font-family: 'Barlow', sans-serif; 
			color: black; 
			font-size: 16px;
		}

		#bookInfo {
			font-family: 'Noto Sans', sans-serif; 
			color: black; 
			font-size: 13px; 
			letter-spacing: 0.1em; 
			margin-top: 4px; 
			margin-bottom: 4px;
		}

		#bookCategory {
			font-family: 'Noto Sans', sans-serif; 
			color: black; 
			font-size: 13px; 
			letter-spacing: 0.1em;
		}

		#bookStatus {
			margin-top: 23px;
			font-family: 'Noto Sans', sans-serif; 
			font-size: 13px; 
			letter-spacing: 0.1em;
		}

		th, td {
			font-family: 'Noto Sans', sans-serif; 
			color: black; 
			font-size: 13px; 
			letter-spacing: 0.1em;
		}

		.panel-heading {
			font-family: 'Noto Sans', sans-serif; 
			color: black; 
			font-size: 13px; 
			letter-spacing: 0.1em;
		}

		.loan-type {
			font-family: 'Montserrat', sans-serif; 
			color: black; 
			font-size: 20px;
			margin-bottom: 10px; 
			margin-left: -1em
		}

		.loan-result-header {
			font-family: 'Barlow', sans-serif; 
			color: black; 
			font-size: 15px;
			margin-top: -11px;
			margin-left: -1em;
			margin-bottom: 1em;
			letter-spacing: 0.1em; 
		}

		.bookInfoInsert {
			border: 2px black;
			border-radius: 10%;
		}

		.book_status_shelf {
			border-left: 5px green solid; 
			padding-left: 15px;
		}

		.book_status_missing {
			border-left: 5px #b30000 solid; 
			padding-left: 15px;
		}

		.book_status_loan {
			border-left: 5px grey solid; 
			padding-left: 15px;
		}

	</style>
{% endblock %}

{% block scripts %}
	{{ super() }}
	<script>

		$(function() {
			let ascending=true;
			$('#sortButton').click(
				function(event) {
					if (ascending) {
						sortTable('#past_loans_table', 'desc')
						$('#sortButton i')[0].className = 'bi bi-sort-numeric-up'
						ascending = false
					} else {
						sortTable('#past_loans_table', 'asc')
						$('#sortButton i')[0].className = 'bi bi-sort-numeric-down'
						ascending = true
					}
				})
		});


		function sortTable(table, order) {
			const asc = order === 'asc'
			const trows = $(table).find('tbody > tr')

			function compareElem(a, b) {
				const a_parts = a.children[3].innerText.split('-');
				const a_date = new Date(a_parts[0], a_parts[1] - 1, a_parts[2]);
				const b_parts = b.children[3].innerText.split('-');
				const b_date = new Date(b_parts[0], b_parts[1] - 1, b_parts[2]);

				if (asc) {
					return a_date - b_date
				} 
				return b_date - a_date
			}
			trows.sort(compareElem).appendTo(table + ' tbody')
		}
	</script>
{% endblock %}

{% block app_content %}
	<div class="col-sm-8">
		<div style="margin-bottom: 10px; margin-left: -2em">
			<div id="headerTitle">LOAN HISTORY</div>
			<div id="headerSubtitle">VIEW CURRENT AND PAST LOANS FOR THIS BOOK</div>
		</div>
		<div class="card" style="margin-bottom: 1em">
			<div class="card-body"> 
				<div class="row justify-content-end">
		
					<div>
						<div class="row ml-2 justify-content-center align-items-center">
							<div style="border-left: 3px black solid; padding-left: 15px;" class="col-auto">
								<img width="100px" src="{{ book.cover }}">
							</div>
			
							<div class="col-auto">
								<div id="bookTitle"> {{ book.full_title.upper() }} </div>
								<div id="bookAuthor">by: 
									<span style="font-weight: bold;">
										{% for author in list_authors(book.authors, as_list=True) %}
												{{ author }}{% if not loop.last %},{% endif %}
										{% endfor %}
									</span>
								</div>
								<div id="bookInfo">{{ book.pages }} pages | {{ book.publish_date.year }}</div>
								<div id="bookCategory">{{ book.book_category.name }}</div>
											
							</div>
						</div>
					</div>
					
				</div>
			</div>
		</div>

		{% if curr_loan %}
		<div style="margin-top: 5em;">
			<div class="loan-type">CURRENT LOAN</div>
			{% if not curr_loan.is_overdue() %}
				<div class="card text-dark border-success">
					<div style="background-color: #d1e7dd; color: #0f5132;" class="card-header">Status: <span style="font-weight: bold;">AWAY ON LOAN</span></div>
					<table class="table mx-1" id="current_loan_table">
						<tr>
							<th>CONTACT PHONE</th>
							<th>CONTACT NAME</th>
							<th>DATE TAKEN OUT</th>
							<th>DATE DUE</th>
						</tr>
						<tr>
							<td>{{ curr_loan.phone_num }}</td>
							<td>{{ curr_loan.loanee }}</td>
							<td>{{ curr_loan.out_timestamp.strftime('%Y-%m-%d') }}</td>
							<td>{{ curr_loan.in_timestamp.strftime('%Y-%m-%d') }}</td>
						</tr>
					</table>
				</div>
			{% else %}
			<div class="card text-dark border-danger mb-3">
				<div style="background-color: #f1c3c3; color: #7c0101;" class="card-header">Status: <span style="font-weight: bold;">OVERDUE</span></div>
					<table class="table mx-1">
						<tr>
							<th>Contact Phone</th>
							<th>Contact Name</th>
							<th>Date Taken Out</th>
							<th>Date Due</th>
						</tr>
						<tr>
							<td>{{ curr_loan.phone_num }}</td>
							<td>{{ curr_loan.loanee }}</td>
							<td>{{ curr_loan.out_timestamp.strftime('%Y-%m-%d') }}</td>
							<td>{{ curr_loan.in_timestamp.strftime('%Y-%m-%d') }}</td>
						</tr>
					</table>
				</div>
			{% endif %}
			<div>
		{% endif %}

		<div style="margin-top: 5em;">
			<div class="row justify-content-between">
				<div class="col-lg-3">
					<div class="loan-type">PAST LOANS</div>
					<div class="loan-result-header">{{ past_loans['count'] }} PAST LOAN(S) FOUND</div>
				</div>
				<button id="sortButton" type="button" class="col-sm-3 btn" style="font-family: 'Barlow', sans-serif; letter-spacing: 0.05em; margin-top: 15px; border-color: white;">
					<i style="font-size: 1.4em;" class="bi bi-sort-numeric-down"></i> SORT BY RETURN DATE
				</button>
			</div>
			<table class="table table-bordered" id="past_loans_table">
				<thead>
					<tr>
						<th>CONTACT PHONE</th>
						<th>CONTACT NAME</th>
						<th>DATE TAKEN OUT</th>
						<th>DATE RETURNED </th>
					</tr>
				</thead>
				<tbody>
					{% for loan in past_loans['items'] %}
						<tr>
							<td><a href="{{ url_for('loanee_history', phone_num=loan.phone_num)}}">{{ loan.phone_num }}</a></td>
							<td>{{ loan.loanee }}</td>
							<td>{{ loan.out_timestamp.strftime('%Y-%m-%d') }}</td>
							<td>{{ loan.in_timestamp.strftime('%Y-%m-%d') }}</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>
	

	

	
	

<!-- 	<nav aria-label="...">
        <ul class="pager btn-flat">
            <li class="previous{% if not prev_url %} disabled{% endif %}">
                <a href="{{ prev_url or '#' }}">
                    <span aria-hidden="true">&larr;</span> PREVIOUS LOANS
                </a>
            </li>
            <li class="next{% if not next_url %} disabled{% endif %}">
                <a href="{{ next_url or '#' }}">
                    MORE LOANS <span aria-hidden="true">&rarr;</span>
                </a>
            </li>
        </ul>
    </nav>
 -->

{% endblock %}



